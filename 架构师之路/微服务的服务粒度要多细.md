# Table of Contents

* [1  粗粒度 一个服务层](#1--粗粒度-一个服务层)
* [2  一个子业务一个service](#2--一个子业务一个service)
* [3  一个数据表对应一个service](#3--一个数据表对应一个service)
* [4  一个接口对应一个service](#4--一个接口对应一个service)
* [5  粒度粗细的优劣](#5--粒度粗细的优劣)
* [6  总结](#6--总结)


大家也都认可，随着数据量、流量、业务复杂度的提升，服务化架构是架构演进中的必由之路，今天要讨论的话题是：微服务架构多“微”才合适？

# 1  粗粒度 一个服务层

![image-20190712104138009](http://ww1.sinaimg.cn/large/006tNc79ly1g4wv2vxzh0j30ax0910vy.jpg)

最粗犷的玩法，所有基础数据的访问，都通过一个service访问，在业务不是特别复杂的时候还好，一旦业务变复杂了，这个service层会变得非常重，成为耦合点之一，**以微信场景为例**，假设有一个通用的服务层来访问基础数据，这个服务层可能是这样的：

![image-20190712104157652](http://ww3.sinaimg.cn/large/006tNc79ly1g4wv2wcu3tj30ea06m0vy.jpg)

有一个统一的service层，用户信息，好友信息，群组信息，消息信息都通过这个service层来走。

细节：微信单对单消息是一个写多读少的业务，故没有缓存。



# 2  一个子业务一个service

如果所有的信息存储都在一个service里，那么一个地方出bug，就将影响整个业务，所以更合理的做法是在服务层进行细分，架构如何细分？垂直拆分是个好的方案，将子业务一个个拆出来，那么微信的服务化架构或许会变成这个样子：

![image-20190712104245557](http://ww4.sinaimg.cn/large/006tNc79ly1g4wv2ws053j30e506jgp3.jpg)

（1）**用户**相关的子业务有user-service

（2）**好友**相关的子业务有friend-service

（3）**群组**相关的子业务有group-service

（4）**消息**相关的子业务有msg-service

这样的话，一个service出问题也不会影响其他service，同时数据层也按照业务垂直拆分开了。

服务粒度变细之后，出现一个新的问题，业务与服务的连接关系变复杂了，有什么好的优化方案么？

![image-20190712104308518](http://ww2.sinaimg.cn/large/006tNc79ly1g4wv2xa6ylj30e907tae0.jpg)

常见的，加入一个高可用服务分发层集群，并在协议设计时加入服务号，可以减少蜘蛛网状的依赖关系：

（1）调用方依赖分发层，传入服务号

（2）分发层依赖服务层，通过服务号参数分发



# 3  一个数据表对应一个service

数据访问service最初是从DAO/ORM的数据访问需求过来的，所以有些公司也有一个数据表一个service的玩法。

一个子业务对应一个service的玩法是：

![image-20190712104350126](http://ww3.sinaimg.cn/large/006tNc79ly1g4wv2xuu8mj30a003udgt.jpg)

（1）服务层，整个群业务是一个service

（2）存储层，实际可能对应了群信息、群成员、群消息等多个数据表

 

拆分成一个数据表一个service，则架构会变成这样：

![image-20190712104451813](http://ww2.sinaimg.cn/large/006tNc79ly1g4wv2yq4ykj30b6062767.jpg)

**群信息表，群成员表，群消息表**等各个数据表之间也解耦开了，不会相互影响了。



# 4  一个接口对应一个service

微服务架构中更极端的，甚至一个接口对应一个微服务，这样的话，架构就从：

![image-20190712104529595](http://ww4.sinaimg.cn/large/006tNc79ly1g4wv2zobx9j304904c74q.jpg)

演化为：

![image-20190712104548799](http://ww2.sinaimg.cn/large/006tNc79ly1g4wv303orwj308w04mt9v.jpg)

（1）**修改群信息**服务

（2）**增加群信息**服务

（3）**获取群信息**服务

多个服务操纵同一个数据表，使用同一片缓存，每个接口出问题，都不会影响其他接口。



# 5  粒度粗细的优劣

上文中谈到的服务化与微服务，不同粒度的服务化各有什么优劣呢？

总的来说，细粒度拆分的**优点**有：

（1）服务都能够独立部署

（2）扩容和缩容方便，有利于提高资源利用率

（3）拆得越细，耦合相对会减小

（4）拆得越细，容错相对会更好，一个服务出问题不影响其他服务

（5）扩展性更好

（6）…

 

细粒度拆分的**不足**也很明显：

（1）拆得越细，系统越复杂

（2）系统之间的依赖关系也更复杂

（3）运维复杂度提升

（4）监控更加复杂

（5）出问题时定位问题更难

（6）…



# 6  总结

聊了许多，有网友问，笔者对待服务化以及微服务粒度的看法，个人觉得，**以“子业务系统”粒度作为微服务的单位是比较合适**的：

![image-20190712104702411](http://ww2.sinaimg.cn/large/006tNc79ly1g4wv30ougnj30e307mtcm.jpg)

