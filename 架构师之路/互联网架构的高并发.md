# Table of Contents

* [1  什么是高并发](#1--什么是高并发)
* [2  如何提升系统的并发能力](#2--如何提升系统的并发能力)
  * [2.1 解决方法](#21-解决方法)
  * [2.2 垂直扩展实践分析](#22-垂直扩展实践分析)
  * [2.3 水平扩展实践分析](#23-水平扩展实践分析)
    * [2.3.1 反向代理层的水平扩展](#231-反向代理层的水平扩展)
    * [2.3.2 站点层的水平扩展](#232-站点层的水平扩展)
    * [2.3.3 服务层的水平扩展](#233-服务层的水平扩展)
    * [2.3.4 数据层的水平扩展](#234-数据层的水平扩展)
* [3  总结](#3--总结)


# 1  什么是高并发

**高并发（**High Concurrency）是互联网分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计保证系统能够同时并行处理很多请求。



高并发相关常用的一些指标有响应时间（Response Time），吞吐量（Throughput），每秒查询率QPS（Query Per Second），并发用户数等。



**响应时间**：系统对请求做出响应的时间。例如系统处理一个HTTP请求需要200ms，这个200ms就是系统的响应时间。

**吞吐量**：单位时间内处理的请求数量。

**QPS**：每秒响应请求数。在互联网领域，这个指标和吞吐量区分的没有这么明显。

**并发用户数**：同时承载正常使用系统功能的用户数量。例如一个即时通讯系统，同时在线量一定程度上代表了系统的并发用户数。



# 2  如何提升系统的并发能力

## 2.1 解决方法

- 垂直扩展
- 水平扩展
- 架构调整如下所示：

![image-20190708175839381](http://ww1.sinaimg.cn/large/006tNc79ly1g4slbe35axj30j00ctwlo.jpg)



## 2.2 垂直扩展实践分析

**增强单机硬件性能，如升级CPU，硬盘等**

- 比如数据库采用SSD硬盘，增加CPU核并扩大内存，能快速显著提升性能
- 方法简易，但是单机性能有极限，很快遇到天花板

**增加Cache，极大减少IO次数**

- Redis充当数据库热点缓存，极大的减少数据库IO

- 函数缓存或者页面缓存，极大减少计算逻辑

- 缓存直接当数据库使用，存储高频数据，比如Session的缓存改造

- 缓存引用面临的问题

- - 数据一致性维护，比如缓存数据库热点数据时，缓存和数据库的一致性？
  - 缓存命中率，缓存穿透
  - 缓存雪崩(集体失效)

**分布式任务队列提高服务吞吐量**

- 上游不太关心执行结果，异步执行任务，比如消息推送，短信通知等；
- 请求量暴增，时效性要求不高，采用异步削平一些请求峰值，比如新闻阅读，增加新闻阅读数

**动静分离**

- 业务场景有许多静态资源，把网站静态资源(html, css等)存放在第三方CDN，与后台应用分开，提高用户访问静态代码的速度，并降低对后台应用访问



## 2.3 水平扩展实践分析

![image-20190708180132578](http://ww4.sinaimg.cn/large/006tNc79ly1g4slbextx1j30bo0aawhb.jpg)

常见互联网分布式架构如上，分为：

（1）**客户端层**：典型调用方是浏览器browser或者手机应用APP

（2）**反向代理层**：系统入口，反向代理

（3）**站点应用层**：实现核心应用逻辑，返回html或者json

（4）**服务层**：如果实现了服务化，就有这一层

（5）**数据**-**缓存层**：缓存加速访问存储

（6）**数据**-**数据库层**：数据库固化数据存储

整个系统各层次的水平扩展，又分别是如何实施的呢？



### 2.3.1 反向代理层的水平扩展

![image-20190708180346884](http://ww4.sinaimg.cn/large/006tNc79ly1g4slbfi7wtj30eq03odgl.jpg)

反向代理层的水平扩展，是通过“DNS轮询”实现的：dns-server对于一个域名配置了多个解析ip，每次DNS解析请求来访问dns-server，会轮询返回这些ip。

当nginx成为瓶颈的时候，只要增加服务器数量，新增nginx服务的部署，增加一个外网ip，就能扩展反向代理层的性能，做到理论上的无限高并发。

### 2.3.2 站点层的水平扩展

![image-20190708180415560](http://ww2.sinaimg.cn/large/006tNc79ly1g4slbfva8fj309802adg6.jpg)

站点层的水平扩展，是通过“nginx”实现的。通过修改nginx.conf，可以设置多个web后端。

当web后端成为瓶颈的时候，只要增加服务器数量，新增web服务的部署，在nginx配置中配置上新的web后端，就能扩展站点层的性能，做到理论上的无限高并发。

### 2.3.3 服务层的水平扩展

![image-20190708180437378](http://ww2.sinaimg.cn/large/006tNc79ly1g4slbgakxnj307t04l0t8.jpg)

服务层的水平扩展，是通过“服务连接池”实现的。

站点层通过RPC-client调用下游的服务层RPC-server时，RPC-client中的连接池会建立与下游服务多个连接，当服务成为瓶颈的时候，只要增加服务器数量，新增服务部署，在RPC-client处建立新的下游服务连接，就能扩展服务层性能，做到理论上的无限高并发。如果需要优雅的进行服务层自动扩容，这里可能需要配置中心里服务自动发现功能的支持。

### 2.3.4 数据层的水平扩展

在数据量很大的情况下，数据层（缓存，数据库）涉及数据的水平扩展，将原本存储在一台服务器上的数据（缓存，数据库）水平拆分到不同服务器上去，以达到扩充系统性能的目的。

 

互联网数据层常见的水平拆分方式有这么几种，以数据库为例：

**按照范围水平拆分**

![image-20190708180509069](http://ww2.sinaimg.cn/large/006tNc79ly1g4slbgvz4nj308s038q3d.jpg)

每一个数据服务，存储一定范围的数据，上图为例：

user0库，存储uid范围1-1kw

user1库，存储uid范围1kw-2kw

这个方案的好处是：

（1）规则简单，service只需判断一下uid范围就能路由到对应的存储服务；

（2）数据均衡性较好；

（3）比较容易扩展，可以随时加一个uid[2kw,3kw]的数据服务；

不足是：

（1）      请求的负载不一定均衡，一般来说，新注册的用户会比老用户更活跃，大range的服务请求压力会更大；



**按照哈希水平拆分**

![image-20190708180528462](http://ww4.sinaimg.cn/large/006tNc79ly1g4slbhrn2yj307n03h3yv.jpg)

每一个数据库，存储某个key值hash后的部分数据，上图为例：

user0库，存储偶数uid数据

user1库，存储奇数uid数据

这个方案的好处是：

（1）规则简单，service只需对uid进行hash能路由到对应的存储服务；

（2）数据均衡性较好；

（3）请求均匀性较好；

不足是：

（1）不容易扩展，扩展一个数据服务，hash方法改变时候，可能需要进行数据迁移；

 

这里需要注意的是，**通过水平拆分来扩充系统性能，与主从同步读写分离来扩充数据库性能的方式有本质的不同。**

通过水平拆分扩展数据库性能：

（1）每个服务器上存储的数据量是总量的1/n，所以单机的性能也会有提升；

（2）n个服务器上的数据没有交集，那个服务器上数据的并集是数据的全集；

（3）数据水平拆分到了n个服务器上，理论上读性能扩充了n倍，写性能也扩充了n倍（其实远不止n倍，因为单机的数据量变为了原来的1/n）；

通过主从同步读写分离扩展数据库性能：

（1）每个服务器上存储的数据量是和总量相同；

（2）n个服务器上的数据都一样，都是全集；

（3）理论上读性能扩充了n倍，写仍然是单点，写性能不变；

 

缓存层的水平拆分和数据库层的水平拆分类似，也是以范围拆分和哈希拆分的方式居多，就不再展开。



# 3  总结

**高并发（**High Concurrency）是互联网分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计保证系统能够同时并行处理很多请求。

提高系统并发能力的方式，方法论上主要有两种：垂直扩展（Scale Up）与水平扩展（Scale Out）。前者垂直扩展可以通过提升单机硬件性能，或者提升单机架构性能，来提高并发性，但单机性能总是有极限的，互联网分布式架构设计高并发终极解决方案还是后者：水平扩展。

互联网分层架构中，各层次水平扩展的实践又有所不同：

（1）**反向代理层可以通过“DNS轮询”的方式来进行水平扩展**；

（2）**站点层可以通过nginx来进行水平扩展；**

（3）**服务层可以通过服务连接池来进行水平扩展；**

（4）**数据库可以按照数据范围，或者数据哈希的方式来进行水平扩展；**

各层实施水平扩展后，能够通过增加服务器数量的方式来提升系统的性能，做到理论上的性能无限。

